<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ESP32 配网</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('form').addEventListener('submit', function(event) {
                event.preventDefault(); // 阻止表单默认提交行为
                getPorts().then(ports => {
                    if (ports.length > 0) {
                        const port = ports[0]; // 选择第一个端口
                        connectToESP32(port);
                    } else {
                        console.log('No serial ports found.');
                    }
                }).catch(error => {
                    console.error('Error accessing serial ports:', error);
                });
            });
        });

        async function getPorts() {
            try {
                return await navigator.serial.getPorts();
            } catch (error) {
                throw error;
            }
        }

        async function connectToESP32(port) {
            try {
                const options = { baudRate: 115200 };
                const connection = await port.open(options);
                const reader = connection.readable.getReader();
                const encoder = new TextEncoder();
                const decoder = new TextDecoder();

                // 读取用户输入的WiFi信息
                const wifiSSID = document.getElementById('wifi_id').value;
                const wifiPassword = document.getElementById('password').value;

                // 构造AT指令
                const command = `AT+CWJAP_CUR="${wifiSSID}","${wifiPassword}"\r\n`;

                // 发送AT指令
                const encodedCommand = encoder.encode(command);
                const writeResult = await connection.writable.write(encodedCommand);
                console.log('Command written:', writeResult);

                // 读取响应
                const readResult = await reader.read();
                console.log('Response read:', decoder.decode(readResult.value));

                // 关闭连接
                await port.close();
            } catch (error) {
                console.error('Error connecting to ESP32:', error);
            }
        }
    </script>
</head>
<body>
    <h1>ESP32 配网</h1>
    <form id="form">
        <label for="wifi_id">WiFi SSID:</label>
        <input type="text" id="wifi_id" name="wifi_id" required><br><br>
        <label for="password">密码:</label>
        <input type="password" id="password" name="password" required><br><br>
        <input type="submit" value="配网">
    </form>
</body>
</html>
