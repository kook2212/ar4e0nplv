<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ESP32 WiFi Configuration</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('configure').addEventListener('click', configureWiFi);
        });

        async function configureWiFi() {
            try {
                const port = await navigator.serial.requestPort();
                console.log('Port requested:', port);

                const options = { baudRate: 115200 };
                await port.open(options);
                console.log('Port opened:', port.readable, port.writable);

                if (!(port.readable && port.writable)) {
                    throw new Error('Failed to open the port properly.');
                }

                const ssid = document.getElementById('ssid').value;
                const password = document.getElementById('password').value;
                const command = `AT+CWJAP_DEF="${ssid}","${password}"\r\n`;
                console.log('Command to send:', command);

                const encoder = new TextEncoder();
                const encodedCommand = encoder.encode(command);
                await port.writable.write(encodedCommand);
                console.log('Command sent.');

                // 等待一些时间以确保ESP32处理指令
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 读取响应
                const reader = port.readable.getReader();
                let response = '';
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    response += new TextDecoder().decode(value);
                    console.log('Received from ESP32:', response);
                }

                await port.close();
                console.log('Port closed.');

                alert('WiFi configuration sent and response received.');
            } catch (error) {
                console.error('Error configuring WiFi:', error);
                if (port) {
                    await port.close();
                }
                alert('Error configuring WiFi: ' + error.message);
            }
        }
    </script>
</head>
<body>
    <h1>ESP32 WiFi Configuration</h1>
    <label for="ssid">SSID:</label>
    <input type="text" id="ssid" name="ssid" required>
    <br><br>
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required>
    <br><br>
    <button id="configure">Configure WiFi</button>
</body>
</html>
